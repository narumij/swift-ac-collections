# RedBlackTreeModule

## コレクション

- RedBlackTreeSet
- RedBlackTreeMultiSet
- RedBlackTreeDictionary
- RedBlackTreeMultiMap

- SequenceやCollectionやBidirectionalCollection対応はプロトコルで実装をまとめています。
- それ以外は実装してはいますが、チェックか中継ばかりでほとんどの実装は内部にあります。
- コメントちゃんと書くようにメソッド生やしている感じです。
- 初心者にとって難しい、型推論エラーの解決が発生しないよう配慮することが優先

## `__tree`ディレクトリ

- LLVMの移植部分
- protocol抽象となっている
- 命名は元のソースに倣う
- C++でのポインタとイテレータは移植後のコードで区別はない
- メンバアクセスにドット記法やアロー記法を使わないため、簡易なCに近い
- プロトコルの命名にprefixは特にない
- swift-formatはするが、それ以外はC++との目視照らし合わせが楽なことが優先

## `_Tree`ディレクトリ

- 内部木の実装
- 型インジェクションでエレメントの種類と比較の仕方と重複の有無を切り替えている
- プロトコル適合することで`__tree_`のプロトコルを各種利用している
- コレクションに対して不足している部分を追加で実装している
- C++に無い内部実装は`___`をprefixにつけている
- 内部木に対するプロトコルは`Tree_`をprefixにつけている

## RedBlackTreeディレクトリ

- 各コレクションの共通実装部
- 内部木をメンバとして持つ
- 非公開メンバは`___`をprefixにつけている
- `___RedBlackTreeBase`プロトコルは、名前を`RedBlackTree`としてもいいのではないかと悩んでいる
- 非公開扱いとしながら生々しいものも結構publicにしている。提出での利用が余りに多いものがあれば、将来的に公開に昇格するのもよし。
- 初心者にとって難しい、型推論エラーの解決が発生しないよう配慮することが優先

## Storageディレクトリ

- Copy On Writeの実行部の実装
- コレクションだけがStorageを参照していて、この参照数でCopyOnWriteをしている
- 強めのCoWが他にある。違いについて共通実装のCopyOnWriteを参照してください

## Memoizeディレクトリ

- メモ化向けのコンテナ
- swift-ac-memoizeはドロップしたので、趣味的なモノです

## 全体について

- 非公開の初期化子のパラメータラベルにアンスコ(_)を使うのは、コレクションでは採用するが、それ以外では減らしている
- `_NodePtr`と各種インデックスへの相互変換は公開しない
- インデックスから生インデックスへの変換は公開しない
- つまりインデックスに集約されるようにする
- 生インデックスと`_NodePtr`(aka Int)は、インデックスに何か性能上の不都合が発見されたときのための、あくまでも予備

- `Index`及び`___Iterator`は、Stridableにしない。した場合、標準のSequence実装が生えるし、標準のSequence実装は毎要素アクセス毎に範囲チェックをし、これが毎度O(log n)かかるため、性能が悲惨になる。この問題を回避する標準的な方法が見つかるまで、Stridableにはしない。

- コレクションのinitは軽めのモノについて、inlinable, inline alwaysにする。
- 内部データ構造のinitは全てinlinable, inline alwaysにする

- それ以外の部分についてinline alwaysにするかどうかの方針は定まっていません。
- 頻繁に呼ばれている箇所が計測で見つかり、そこをinline alwaysにすることで速くなることが確認できた上でするのが望ましいです。
- 正直感覚的にinline alwaysにしてしまう場合があったりしますが、しない方が速いケースもあるのでなんとも言いがたいです。
- あとづけですが、O(1)は必ずinline alwaysに、O(1)以外は基本inline alwaysにしない。O(1)以外で繰り返し呼ばれやすい部分はinline alwaysにする、というのがベースになりそうです。

- デバッグ関連メソッドを除いて全てのメソッドや計算プロパティにはinlinableをつけます。これは特殊化されず関数テーブルに載るとルックアップ（？）のオーバーヘッドが競プロ用としては耐えがたく遅いからです。
